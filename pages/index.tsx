import type { NextPage } from "next";
import Head from "next/head";
import Image from "next/image";
import styles from "../styles/Home.module.css";
import { useState, useEffect } from "react";

type HomeProps = {
  discussions: Discussion[];
  labels: Label[];
};

function getDates() {
  let today = new Date();
  const dayOfWeek = today.getDay();
  const difference = today.getDate() - dayOfWeek;
  let sunday = new Date(today);
  sunday.setDate(difference);
  let saturday = new Date(sunday);
  saturday.setDate(sunday.getDate() + 6);
  const dateString = today.toISOString().split("T")[0];
  const startDate = sunday.toISOString().split("T")[0];
  const endDate = today.toISOString().split("T")[0];

  return {
    startDate,
    endDate,
  };
}
const dates = getDates();

const Home: NextPage<HomeProps> = () => {
  const [selectedLabel, setSelectedLabel] = useState<Label>();
  const [labels, setLabels] = useState<Label[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [discussions, setDiscussions] = useState<Discussion[]>([]);
  const [displayDiscussions, setDisplayDiscussions] = useState<Discussion[]>(
    []
  );
  const [isLoading, setLoading] = useState<Boolean>(false);
  const [startDate, setStartDate] = useState<string>(dates.startDate);
  const [endDate, setEndDate] = useState<string>(dates.endDate);
  const [discussionCounts, setDiscussionCounts] = useState<Counts>();

  useEffect(() => {
    setLoading(true);

    const fetchData = async () => {
      let responses = await Promise.allSettled([
        fetch(
          `http://localhost:3000/api/discussions?startDate=${startDate}&endDate=${endDate}`
        ),
        fetch(`http://localhost:3000/api/labels`),
      ]);
      let discussions =
        responses[0].status === "fulfilled"
          ? await (
              responses[0] as PromiseFulfilledResult<Response>
            ).value.json()
          : [];
      let attr =
        responses[1].status === "fulfilled"
          ? await (
              responses[1] as PromiseFulfilledResult<Response>
            ).value.json()
          : [];

      setDiscussions(discussions);
      setDisplayDiscussions(discussions);
      setLabels(attr?.labels);
      setCategories(attr?.categories);
      setLoading(false);

      calculateDiscussionCounts(discussions, attr?.labels);
    };

    fetchData().catch(console.error);
  }, [startDate, endDate]);

  let calculateDiscussionCounts = (
    allDiscussions: Discussion[],
    allLabels: Label[]
  ) => {
    let labels = allLabels.map((label) => {
      let matches = allDiscussions.filter((discussion) =>
        discussion.labels.some((l) => l.name === label.name)
      );
      return { name: label.name, id: label.id, count: matches.length };
    });

    let categories: { id: string; name: string; count: number }[] = [];
    allDiscussions.forEach((discussion) => {
      let matchingCategory =
        categories &&
        categories.find((category) => {
          return category.id === discussion.category.id;
        });
      if (matchingCategory) {
        matchingCategory.count++;
      } else {
        categories.push({ ...discussion.category, count: 1 });
      }
    });

    setDiscussionCounts({
      labels,
      categories,
    });
  };

  let getFirstResponseCount = () => {
    // quickly, but not-necessarily-reliably, count first comments that came from me
    return discussions.filter((d) => {
      return (
        d?.comments.length &&
        d.comments[0].author.login === "amyegan" &&
        d.comments[0].author.login !== d.author.login
      );
    }).length;
  };

  let handleLabelSelectionChange = (event: any) => {
    let newLabel = event.target.value;
    setSelectedLabel(newLabel);

    if (newLabel) {
      let filteredDiscussions = discussions.filter((discussion) => {
        return discussion.labels.some((l) => l.name === newLabel);
      });
      setDisplayDiscussions(filteredDiscussions);
      return;
    } else {
      setDisplayDiscussions(discussions);
    }
  };

  let handleSubmit = (event: any) => {
    event.preventDefault();

    let selectedLabel = event.target.githubLabel.value;
  };

  if (isLoading) return <p>Loading...</p>;

  return (
    <div className={styles.container}>
      <Head>
        <title>Discussion Tools</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <h1 className={styles.title} style={{ marginBottom: "0.5em" }}>
          Welcome!
        </h1>

        <p>
          {discussions.length} discussions from {startDate} through {endDate}
        </p>

        <div style={{ paddingBottom: "2em" }}>
          <>
            Marked &quot;answered&quot; this week:{" "}
            {
              discussions.filter((d) => {
                if (d.answerChosenAt) {
                  const answerDate = new Date(d.answerChosenAt);
                  return (
                    answerDate >= new Date(startDate) &&
                    answerDate <= new Date(endDate)
                  );
                }
              }).length
            }
            <br />
            <br />
            Labels used this week:{" "}
            <ul>
              {discussionCounts &&
                discussionCounts.labels.map((l) => {
                  return (
                    <li key={l.id}>
                      {l.name}: {l.count}
                    </li>
                  );
                })}
            </ul>
            Categories used this week:{" "}
            <ul>
              {discussionCounts &&
                discussionCounts.categories.map((c) => {
                  return (
                    <li key={c.id}>
                      {c.name}: {c.count}
                    </li>
                  );
                })}
            </ul>
            <p>Times first comment came from me: {getFirstResponseCount()}</p>
          </>
        </div>

        <form
          style={{ marginBottom: "2em" }}
          onSubmit={(e) => {
            handleSubmit(e);
          }}
        >
          <div>
            <label htmlFor="githubLabel">Label filter </label>
            <select
              name="label"
              id="githubLabel"
              onChange={(e) => {
                handleLabelSelectionChange(e);
              }}
            >
              <option value="">--Please choose an option--</option>
              {labels &&
                labels.map((label) => (
                  <option value={label.name} key={label.id}>
                    {label.name}
                  </option>
                ))}
            </select>
            <br />
            <br />

            <label htmlFor="githubCategory">Category filter </label>
            <select name="category" id="githubCategory">
              <option value="">--Please choose an option--</option>
              {categories &&
                categories.map((category) => (
                  <option value={category.name} key={category.id}>
                    {category.name}
                  </option>
                ))}
            </select>
          </div>

          {/* <div>
            <label>
              Start date ({startDate})
              <input
                type="date"
                value={startDate}
                onChange={(e) => {
                  setStartDate(e.target.value);
                }}
              ></input>
            </label>
          </div>

          <div>
            <label>
              End date ({endDate})
              <input
                type="date"
                value={endDate}
                onChange={(e) => {
                  setEndDate(e.target.value);
                }}
              ></input>
            </label>
          </div> */}
        </form>
        <div className={styles.grid}>
          {displayDiscussions.map((discussion) => (
            <div key={discussion.id} className={styles.card}>
              <a href={discussion.url} target="_blank" rel="noreferrer">
                <h3>{discussion.title}</h3>
                <p>
                  {discussion.number} - {discussion.title}
                </p>
                <p>{`Updated: ${discussion.updatedAt}`}</p>
                <p>{`Answered: ${Boolean(discussion.answerChosenAt)}`}</p>
                <p>{`Comment count: ${discussion.comments.length}`}</p>
                <div>
                  <ul>
                    {discussion?.labels?.length > 0 &&
                      discussion.labels.map((label) => (
                        <li key={label.id}>{label.name}</li>
                      ))}
                  </ul>
                </div>
              </a>
            </div>
          ))}
        </div>
      </main>

      <footer className={styles.footer}>
        <a
          href="https://vercel.com?utm_source=create-next-app&utm_medium=default-template&utm_campaign=create-next-app"
          target="_blank"
          rel="noopener noreferrer"
        >
          Powered by{" "}
          <span className={styles.logo}>
            <Image src="/vercel.svg" alt="Vercel Logo" width={72} height={16} />
          </span>
        </a>
      </footer>
    </div>
  );
};

type Discussion = {
  title: string;
  id: string;
  author: {
    login: string;
    url: string;
  };
  number: string;
  url: string;
  createdAt: Date;
  updatedAt: Date;
  answerChosenAt?: Date;
  labels: Array<Label>;
  category: {
    id: string;
    name: string;
  };
  comments: Comment[];
};

type Label = { id: string; name: string; description: string };
type Category = { id: string; name: string; description: string; slug: string };

type Comment = {
  author: {
    login: string;
    url: string;
  };
  createdAt: Date;
  id: string;
  publishedAt: Date;
  url: string;
};

type Counts = {
  labels: { name: string; id: string; count: number }[];
  categories: { id: string; name: string; count: number }[];
};

export default Home;
